{% extends "layout.html" %}

{% block title %}Métricas - Quilmes{% endblock %}

{% block contenido %}
<div class="animate-fade-in-up">
  <!-- Encabezado -->
  <div class="flex items-center justify-between mb-5">
    <div>
      <h1 class="text-2xl font-bold text-white mb-1 flex items-center gap-2">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center">
          <i data-lucide="bar-chart-3" class="w-5 h-5 text-white"></i>
        </div>
        Métricas del Sistema
      </h1>
      <p class="text-gray-400 text-xs">Análisis de rendimiento y estadísticas</p>
    </div>
    <button onclick="cargarMetricas()" class="px-3 py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg transition-colors flex items-center gap-1.5 text-xs">
      <i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i>
      Actualizar
    </button>
  </div>

  <!-- Tasa de Éxito/Fallo -->
  <div class="glass-effect border border-white/10 rounded-2xl p-5 mb-5">
    <div class="flex items-center gap-2 mb-4">
      <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-emerald-500 to-emerald-600 flex items-center justify-center">
        <i data-lucide="pie-chart" class="w-4 h-4 text-white"></i>
      </div>
      <h2 class="text-lg font-bold text-white">Tasa de Éxito/Fallo de Envíos</h2>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
      <!-- Total -->
      <div class="bg-white/5 rounded-lg p-3 border border-white/10">
        <div class="text-gray-400 text-xs mb-1">Total de SMS</div>
        <div class="text-2xl font-bold text-white" id="totalSms">-</div>
      </div>

      <!-- Exitosos -->
      <div class="bg-emerald-500/10 rounded-lg p-3 border border-emerald-500/30">
        <div class="text-emerald-400 text-xs mb-1">SMS Exitosos</div>
        <div class="text-2xl font-bold text-emerald-400" id="smsExitosos">-</div>
        <div class="text-[10px] text-emerald-400/70 mt-0.5" id="porcentajeExito">-</div>
      </div>

      <!-- Fallidos -->
      <div class="bg-red-500/10 rounded-lg p-3 border border-red-500/30">
        <div class="text-red-400 text-xs mb-1">SMS Fallidos</div>
        <div class="text-2xl font-bold text-red-400" id="smsFallidos">-</div>
        <div class="text-xs text-red-400/70 mt-1" id="porcentajeFallo">-</div>
      </div>
    </div>

    <!-- Barra de comparación -->
    <div class="w-full h-4 bg-gray-800 rounded-full overflow-hidden flex">
      <div id="barraExito" class="bg-gradient-to-r from-emerald-500 to-emerald-400 transition-all duration-500" style="width: 0%"></div>
      <div id="barraFallo" class="bg-gradient-to-r from-red-500 to-red-400 transition-all duration-500" style="width: 0%"></div>
    </div>
  </div>

  <!-- SMS por Usuario Operador -->
  <div class="glass-effect border border-white/10 rounded-2xl p-8 mb-8">
    <div class="flex items-center gap-3 mb-6">
      <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center">
        <i data-lucide="users" class="w-5 h-5 text-white"></i>
      </div>
      <h2 class="text-xl font-bold text-white">SMS por Usuario Operador</h2>
    </div>

    <div id="listaUsuarios" class="space-y-4">
      <!-- Se llena dinámicamente -->
    </div>
  </div>

  <!-- SMS por Hora del Día (últimas 24h) -->
  <div class="glass-effect border border-white/10 rounded-2xl p-8">
    <div class="flex items-center gap-3 mb-6">
      <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-amber-500 to-amber-600 flex items-center justify-center">
        <i data-lucide="clock" class="w-5 h-5 text-white"></i>
      </div>
      <h2 class="text-xl font-bold text-white">Actividad por Hora (Últimas 24h)</h2>
    </div>

    <div id="graficoPorHora" class="space-y-2">
      <!-- Se llena dinámicamente -->
    </div>
  </div>
</div>

<!-- Toast Container -->
<div id="toastContainer" class="fixed top-4 right-4 z-[9999] flex flex-col gap-2 pointer-events-none"></div>

{% endblock %}

{% block scripts %}
<script>
  lucide.createIcons();

  // Cargar métricas al inicio
  document.addEventListener('DOMContentLoaded', cargarMetricas);

  async function cargarMetricas() {
    try {
      const res = await fetch('/api/registros/metricas');
      const data = await res.json();

      if (data.ok) {
        const { datos } = data;

        // Tasa de éxito/fallo
        const tasaExito = datos.tasa_exito_fallo;
        document.getElementById('totalSms').textContent = tasaExito.total.toLocaleString();
        document.getElementById('smsExitosos').textContent = tasaExito.exitosos.toLocaleString();
        document.getElementById('smsFallidos').textContent = tasaExito.fallidos.toLocaleString();
        document.getElementById('porcentajeExito').textContent = `${tasaExito.tasa_exito.toFixed(1)}% del total`;
        document.getElementById('porcentajeFallo').textContent = `${tasaExito.tasa_fallo.toFixed(1)}% del total`;

        // Barras de comparación
        document.getElementById('barraExito').style.width = tasaExito.tasa_exito + '%';
        document.getElementById('barraFallo').style.width = tasaExito.tasa_fallo + '%';

        // SMS por usuario
        const listaUsuarios = document.getElementById('listaUsuarios');
        listaUsuarios.innerHTML = '';
        
        if (datos.sms_por_usuario.length === 0) {
          listaUsuarios.innerHTML = '<p class="text-gray-400 text-center py-4">No hay datos disponibles</p>';
        } else {
          const maxUsuario = Math.max(...datos.sms_por_usuario.map(u => u.total));
          
          datos.sms_por_usuario.forEach((usuario, index) => {
            const porcentaje = (usuario.total / maxUsuario) * 100;
            const colores = [
              'from-blue-500 to-blue-400',
              'from-purple-500 to-purple-400',
              'from-pink-500 to-pink-400',
              'from-amber-500 to-amber-400',
              'from-green-500 to-green-400'
            ];
            const color = colores[index % colores.length];

            listaUsuarios.innerHTML += `
              <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                <div class="flex items-center gap-3 mb-3">
                  <div class="w-10 h-10 rounded-full bg-gradient-to-br ${color} flex items-center justify-center text-white font-bold text-sm">
                    ${usuario.usuario.charAt(0).toUpperCase()}
                  </div>
                  <div class="flex-1">
                    <div class="text-white font-semibold">${usuario.usuario}</div>
                    <div class="text-xs text-gray-400">Usuario operador</div>
                  </div>
                  <div class="text-right">
                    <div class="text-2xl font-bold text-white">${usuario.total}</div>
                    <div class="text-xs text-gray-400">SMS enviados</div>
                  </div>
                </div>
                <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                  <div class="h-full bg-gradient-to-r ${color} transition-all duration-500" style="width: ${porcentaje}%"></div>
                </div>
              </div>
            `;
          });
        }

        // SMS por hora
        const graficoPorHora = document.getElementById('graficoPorHora');
        graficoPorHora.innerHTML = '';
        
        if (datos.sms_por_hora.length === 0) {
          graficoPorHora.innerHTML = '<p class="text-gray-400 text-center py-4">No hay actividad en las últimas 24 horas</p>';
        } else {
          const maxHora = Math.max(...datos.sms_por_hora.map(h => h.total));
          
          datos.sms_por_hora.forEach(item => {
            const altura = maxHora > 0 ? (item.total / maxHora) * 100 : 0;
            graficoPorHora.innerHTML += `
              <div class="flex items-center gap-4">
                <span class="text-sm text-gray-400 w-20 font-mono">${item.hora}</span>
                <div class="flex-1 h-10 bg-gray-800 rounded-lg overflow-hidden">
                  <div class="h-full bg-gradient-to-r from-amber-500 to-amber-400 flex items-center justify-end pr-3 transition-all duration-500" style="width: ${altura}%">
                    <span class="text-sm text-white font-semibold">${item.total}</span>
                  </div>
                </div>
              </div>
            `;
          });
        }

        mostrarToast('Métricas actualizadas correctamente', 'exito');
      } else {
        mostrarToast(data.mensaje || 'Error al cargar métricas', 'error');
      }
    } catch (error) {
      console.error('Error:', error);
      mostrarToast('Error de conexión', 'error');
    }
  }
</script>
{% endblock %}
