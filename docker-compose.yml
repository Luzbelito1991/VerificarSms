version: '3.8'

services:
  # ========================================
  # üêò PostgreSQL Database
  # ========================================
  postgres:
    image: postgres:15-alpine
    container_name: verificarsms-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-verificarsms}
      POSTGRES_USER: ${POSTGRES_USER:-admin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-admin123}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backups:/backups  # Para backups manuales
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-admin} -d ${POSTGRES_DB:-verificarsms}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - verificarsms-network
    restart: unless-stopped

  # ========================================
  # üî¥ Redis Cache (opcional pero recomendado)
  # ========================================
  redis:
    image: redis:7-alpine
    container_name: verificarsms-redis
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redis123}
    volumes:
      - redis_data:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - verificarsms-network
    restart: unless-stopped

  # ========================================
  # üöÄ FastAPI Application
  # ========================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: verificarsms-app
    environment:
      # Base de datos
      DATABASE_URL: postgresql://${POSTGRES_USER:-admin}:${POSTGRES_PASSWORD:-admin123}@postgres:5432/${POSTGRES_DB:-verificarsms}
      
      # Redis
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis123}@redis:6379/0
      
      # Configuraci√≥n de la app
      SECRET_KEY: ${SECRET_KEY:-change-this-secret-key-in-production}
      DEBUG: ${DEBUG:-false}
      ENVIRONMENT: ${ENVIRONMENT:-production}
      
      # SMS API
      SMS_API_KEY: ${SMS_API_KEY}
      SMS_MODO_SIMULADO: ${SMS_MODO_SIMULADO:-false}
      
      # Email (para recuperaci√≥n de contrase√±as)
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      SMTP_FROM: ${SMTP_FROM}
      
      # CORS
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:8000,http://127.0.0.1:8000}
    
    volumes:
      - ./backups:/app/backups
      - ./logs:/app/logs
      - app_static:/app/static/css  # CSS compilado de Tailwind
    
    ports:
      - "${APP_PORT:-8000}:8000"
    
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    networks:
      - verificarsms-network
    
    restart: unless-stopped

  # ========================================
  # üé® Tailwind CSS Builder (desarrollo)
  # ========================================
  tailwind:
    image: node:20-alpine
    container_name: verificarsms-tailwind
    working_dir: /app
    command: npm run dev
    volumes:
      - ./src:/app/src
      - ./static:/app/static
      - ./package.json:/app/package.json
      - ./tailwind.config.js:/app/tailwind.config.js
      - ./postcss.config.js:/app/postcss.config.js
      - node_modules:/app/node_modules
    profiles:
      - dev  # Solo se ejecuta si se especifica --profile dev
    networks:
      - verificarsms-network

# ========================================
# üì¶ Volumes
# ========================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  app_static:
    driver: local
  node_modules:
    driver: local

# ========================================
# üåê Networks
# ========================================
networks:
  verificarsms-network:
    driver: bridge
