<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Verificaci√≥n por SMS</title>
  <!-- Vinculaci√≥n al CSS compilado por Tailwind -->
  <link rel="stylesheet" href="./css/style.css" />
</head>

<!-- Fondo degradado y centrado vertical/horizontalmente -->
<body class="bg-gradient-to-tr from-green-50 to-white min-h-screen flex items-center justify-center px-4">

  <!-- Formulario principal -->
  <form id="smsForm" class="bg-white shadow-lg rounded-lg p-6 w-full max-w-md space-y-4">
    <!-- T√≠tulo del formulario -->
    <h2 class="text-2xl font-semibold text-center text-green-700">üì± Verificaci√≥n SMS</h2>

    <!-- Campo para DNI -->
    <input type="text" name="personId" placeholder="DNI" required autocomplete="off"
      class="w-full border border-gray-300 rounded px-4 py-2 focus:ring-2 focus:ring-green-500 outline-none" />

    <!-- Campo para n√∫mero de celular -->
    <input type="text" name="phoneNumber" placeholder="N√∫mero de celular" required autocomplete="off"
      class="w-full border border-gray-300 rounded px-4 py-2 focus:ring-2 focus:ring-green-500 outline-none" />

    <!-- Men√∫ desplegable para seleccionar sucursal -->
    <select name="merchantCode" required
      class="w-full border border-gray-300 rounded px-4 py-2 text-gray-700 bg-white focus:ring-2 focus:ring-green-500 outline-none">
      <option value="" disabled selected>Seleccion√° una sucursal</option>
      <option value="776">776 Limite Deportes Alberdi</option>
      <option value="777">777 Limite Deportes Lules</option>
      <option value="778">778 Limite Deportes Famaill√°</option>
      <option value="779">779 Limite Deportes Alderetes</option>
      <option value="781">781 Limite Deportes Banda de R√≠o Sal√≠</option>
    </select>

    <!-- Campo oculto donde se guarda el c√≥digo generado -->
    <input type="hidden" name="verificationCode" id="verificationCode" />

    <!-- Muestra visual del c√≥digo generado -->
    <div id="codeDisplay" class="text-3xl font-bold text-green-600 text-center tracking-widest">----</div>

    <!-- Bot√≥n para generar el c√≥digo aleatorio -->
    <button type="button" onclick="refreshCode()"
      class="w-full bg-gray-100 border border-gray-300 text-gray-700 py-2 rounded hover:bg-gray-200 transition">
      ‚ö° Generar c√≥digo
    </button>

    <!-- Bot√≥n para enviar el formulario (desactivado por defecto) -->
    <button id="submitBtn" type="submit" disabled
      class="w-full bg-[#4DA874] text-white py-2 rounded font-medium hover:bg-[#3e9263] transition shadow-md hover:shadow-lg opacity-50 cursor-not-allowed">
      Enviar SMS
    </button>

    <!-- Caja para mostrar mensajes de √©xito o error -->
    <div id="response" class="text-center font-medium text-sm"></div>

    <!-- Muestra del √∫ltimo mensaje enviado -->
    <div id="lastMessage"
      class="mt-4 bg-[#8dd684] p-3 rounded shadow text-sm text-black font-medium whitespace-pre-line"></div>
  </form>

  <!-- Comportamiento interactivo en JavaScript -->
  <script>
    // Referencias a los elementos del DOM (HTML)
    const form = document.getElementById("smsForm");
    const responseBox = document.getElementById("response");
    const codeField = document.getElementById("verificationCode");
    const codeDisplay = document.getElementById("codeDisplay");
    const lastMessageBox = document.getElementById("lastMessage");
    const submitBtn = document.getElementById("submitBtn");

    // Diccionario para traducir los c√≥digos de sucursal a nombres
    const sucursales = {
      "776": "Alberdi",
      "777": "Lules",
      "778": "Famailla",
      "779": "Alderetes",
      "781": "Banda de Rio Sali"
    };

    // Funci√≥n para generar un c√≥digo aleatorio de 4 d√≠gitos
    function generateCode() {
      return Math.floor(1000 + Math.random() * 9000).toString();
    }

    // Al presionar "Generar c√≥digo", se muestra el c√≥digo y se habilita el bot√≥n de env√≠o
    function refreshCode() {
      const code = generateCode();
      codeField.value = code;
      codeDisplay.textContent = code;

      // Activar bot√≥n de env√≠o visualmente y funcionalmente
      submitBtn.disabled = false;
      submitBtn.classList.remove("opacity-50", "cursor-not-allowed");
    }

    // Evento que se activa al enviar el formulario
    form.addEventListener("submit", async (e) => {
      e.preventDefault(); // Evita que el navegador recargue la p√°gina

      // Limpia mensajes anteriores
      responseBox.textContent = "";
      responseBox.className = "text-center font-medium text-sm";

      // Validaci√≥n: No permitir enviar si no hay c√≥digo generado
      if (!codeField.value || codeField.value.trim() === "") {
        responseBox.textContent = "‚ö†Ô∏è Por favor gener√° un c√≥digo antes de enviar el SMS.";
        responseBox.classList.add("text-yellow-600");
        return;
      }

      // Recolecta los datos del formulario como objeto
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      // Validaci√≥n: DNI no puede estar vac√≠o
      if (!data.personId || data.personId.trim() === "") {
        responseBox.textContent = "‚ö†Ô∏è El campo DNI no puede estar vac√≠o.";
        responseBox.classList.add("text-red-600");
        return;
      }

      // Validaci√≥n: Sucursal no puede estar vac√≠a
      if (!data.merchantCode || data.merchantCode.trim() === "") {
        responseBox.textContent = "‚ö†Ô∏è Seleccion√° una sucursal antes de continuar.";
        responseBox.classList.add("text-red-600");
        return;
      }

      // Intenta enviar los datos al backend
      try {
        const res = await fetch("/send-sms", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });

        const result = await res.json();

        if (res.ok) {
          // Mensaje de √©xito
          responseBox.textContent = "‚úÖ SMS enviado correctamente";
          responseBox.classList.add("text-green-700");

          // Muestra el resumen del mensaje enviado
          const msg = `${result.merchantCode} Limite Deportes ${sucursales[result.merchantCode]} - DNI: ${result.personId} - Su C√≥digo es: ${result.verificationCode}`;
          lastMessageBox.textContent = `üì§ √öltimo mensaje enviado:\n${msg}`;
        } else {
          // Error recibido desde el backend
          responseBox.textContent = `‚ùå ${typeof result.detail === "string" ? result.detail : JSON.stringify(result.detail)}`;
          responseBox.classList.add("text-red-600");
        }
      } catch (error) {
        // Error de conexi√≥n o red
        responseBox.textContent = "‚ùå Error de red: " + error.message;
        responseBox.classList.add("text-red-600");
      }
    });
  </script>

</body>
</html>